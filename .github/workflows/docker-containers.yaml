name: Build Docker containers and push to Docker Hub

on:
  push:
    branches:
    - 'master'
  pull_request:
    branches:
    - 'master'

jobs:
  buildDockerContainers:
    runs-on: "ubuntu-latest"
    env:
      DOCKER_ID: 'cmcquinn'
      GITHUB_ID: 'cmcquinn'
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      IMAGE_NAME: 'mk-cnc-cross-builder'
      PACKAGE_DIR: 'mkhal'
    strategy:
      matrix:
        image_tag: [amd64_8, amd64_9, amd64_10, arm64_9, arm64_10, armhf_8, armhf_9, armhf_10, i386_8, i386_9, i386_10]

    steps:
    - name: Clone this repository
      uses: actions/checkout@v2
      with:
          path: mkcnc

    - name: Get machinekit-hal packages
      run: python scripts/get-mkhal-packages.py -i ${{ env.GITHUB_ID }} -t ${{ matrix.image_tag }} -o ${{ env.PACKAGE_DIR }}
      working-directory: mkcnc

    - name: Build Docker images
      run: scripts/build_debian_docker_image -p ${{ env.PACKAGE_DIR }} -i ${{ env.DOCKER_ID}} -r ${{ env.IMAGE_NAME }} -t ${{ matrix.image_tag }}
      working-directory: mkcnc

    - name: Login to Docker Hub
      run: docker login -u ${{ env.DOCKER_ID }} -p ${{ secrets.DOCKER_TOKEN }}

    - name: Push images to Docker Hub
      run: docker push ${{ env.DOCKER_ID }}/${{ env.IMAGE_NAME }}:${{ matrix.image_tag }}